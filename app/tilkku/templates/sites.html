{% block content %}
<div class="content" style="height: calc(100% - 20px); overflow-y: clip;">
    <div id="sites-site-box">
        <input id="sites-site-search" class="input is-small" type="text" placeholder="Hae...">
        <table id="sites-site-table" class="table is-striped">
        </table>
    </div>
</div>

<script>
function search_sites() {
    var search = $('#sites-site-search').val();
    $.ajax({
        url: 'api/sites/?name=' + search,
        type: 'GET',
        success: function(data) {
            console.log(data);
            var table = $('#sites-site-table');
            table.html('');
            for (var i = 0; i < data.length; i++) {
                var keyup = '';
                if(data[i].area != null) {
                    mouseover = ' onmouseover="show_site_area(' + data[i].area.id + ')"';
                    mouseout = ' onmouseout="hide_site_area(' + data[i].area.id + ')"';
                } else if(data[i].marker != null) {
                    mouseover = ' onmouseover="show_site_marker(' + data[i].marker.id + ')"';
                    mouseout = ' onmouseout="hide_site_marker(' + data[i].marker.id + ')"';
                }
                var row = $('<tr' + mouseover + mouseout + '>');
                row.append($('<td>').text(data[i].name));
                table.append(row);
            }
        }
    });
}
search_sites();

$("#sites-site-search").on('keyup', function() {
    search_sites();
});

var highlight = {
    color: '#ff0000',
    opacity: 0.9,
    fillOpacity: 0.9
};

function show_site_area(id) {
    found = false;
    map.eachLayer(function(layer) {
        if(layer.options.id == id) {
            found = true;
            console.log(layer);
            layer.options.originalStyle = {
                color: layer.options.color,
                opacity: layer.options.opacity,
                fillOpacity: layer.options.fillOpacity
            };
            layer.setStyle(highlight);
        }
    });

    if(!found) {
        map_layers.forEach(function(layer) {
            layer.areas.forEach(function(area) {
                if(area.id == id) {
                    var polydata = highlight;
                    polydata.id = area.id;
                    for(var i = 0; i < area.coordinates.length; i++) {
                        area.coordinates[i] = [area.coordinates[i][1], area.coordinates[i][0]];
                    }
                    area_layer = L.polygon(area.coordinates, polydata);
                    area_layer.bindTooltip("<div style='color: " + layer.style.stroke + ";'>" + area.name + "</div>", highlight);
                    area_layer.on("click", function(e) {
                        console.log(e.target.options);
                    });
                    area_layer.addTo(map);
                }
            });
        });
    }
}

function hide_site_area(id) {
    map.eachLayer(function(layer) {
        if(layer.options.id == id) {
            layer.setStyle(layer.options.originalStyle);
        }
    });
}

</script>
{% endblock %}