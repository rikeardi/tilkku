{% extends "base.html" %}
{% block content %}
<script>
var settings = {
    menu: "visible",
    tool: "chat",
    map: {
        center: {
            lat: 61.205,
            lng: 25.130
        },
        zoom: 15,
        server: 0
    }
}

function refresh_settings() {
    localStorage.setItem('settings', JSON.stringify(settings));
}

if(localStorage.getItem('settings') == null) {
    refresh_settings();
} else {
    settings = JSON.parse(localStorage.getItem('settings'));
}
</script>
<div id="map" style="width: 100%; height: 100%; position: fixed; top: 0; left: 0;"></div>
<div class="columns" style="height: 100%; margin: 0px;">
    <div class="column" style="width: auto; min-width: 66%;">
        <div style="width: 32px; float: right;">
            {% include 'toolbox.html' %}
        </div>
    </div>
    <div id="front-tools" class="column is-third" style="z-index: 2;">
        <div class="box p-0" style="height: calc(100% - 10px);">
            {% include 'tools.html' %}
        </div>
    </div>
</div>
<script>
var home = [61.205, 25.130];
var home_zoom = 15;
var map = L.map('map').setView(settings.map.center, settings.map.zoom);

map_servers = {{ map_servers | safe }};
console.log(map_servers);

map_servers.forEach(function(server) {
    server.layer = L.tileLayer(server.url, {
        attribution: server.attribution,
    });
});

var map_background = map_servers[settings.map.server].layer.addTo(map);

function map_set_bg() {
    map_background.remove();
    map_background = map_servers[settings.map.server].layer.addTo(map);
}

map.on("moveend", function() {
    settings.map.center = map.getCenter();
    settings.map.zoom = map.getZoom();
    refresh_settings();
});

var layers = {{ layers | safe }};
console.log(layers);
layers.forEach(function(layer) {
    console.log(layer);
    layer.layer = L.FeatureGroup();

    var style = {
        stroke: layer.style.stroke,
        fill: layer.style.fill,
        opacity: layer.style.opacity,
        fillOpacity: if(style.opacity >= 0.8) { 1 } else { style.opacity + 0.2 }
    }

    console.log(style);

    layer.areas.forEach(function(area) {
        var alayer = L.polygon(area.coordinates, style).addTo(layer.layer);
    });
//    layer.markers.forEach(function(marker) {
//        L.marker(marker.coordinates, style).addTo(layer.layer);
//    });
});
console.log(layers);

</script>
{% include 'settings.html' %}
{% endblock %}